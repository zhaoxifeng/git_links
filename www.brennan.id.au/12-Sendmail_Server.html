<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <title>Linux Home Server HOWTO - Sendmail Server</title>
  <meta content="Miles Brennan" name="author">
</head>


<body>





























<div style="text-align: center;"><span style="font-weight: bold;"><a name="top"></a>Linux
Home Server HOWTO</span><br>





























</div>





























<table style="width: 100%;" border="0" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="width: 30%; text-align: left;"><a href="11-Squid_Web_Proxy.html">Previous</a><br>





























      </td>





























      <td style="width: 40%; text-align: center;"><a href="index.html">Home</a>
      </td>





























      <td style="width: 30%; text-align: right;"><a href="13-Apache_Web_Server.html">Next</a><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<hr>
<h1>Chapter 12 - Sendmail Server</h1>




































<table style="text-align: left; width: 100%;" border="0" cellpadding="1" cellspacing="1">




























  <tbody>




























    <tr>




























      <td style="width: 140px;"><span style="font-weight: bold;">Versions:</span></td>




























      <td>- sendmail 8.13.6</td>




























    </tr>




























    <tr>




























      <td></td>




























      <td>- dovecot 1.0</td>




























    </tr>




























    <tr>




























      <td></td>




























      <td>- clamav 0.88.2</td>




























    </tr>




























  
  
  
  
  
  <tr>








      <td></td>








      <td>- clamav-milter 0.88.2</td>








    </tr>








    <tr>






















      <td></td>






















      <td>- spamassassin 3.1.3</td>






















    </tr>






















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<span style="font-weight: bold;"></span><br>





























<a href="#config">Basic
Configuration</a><br>








<a href="#dovecot">Dovecot IMAP Server</a><br>





























<a href="#starting">Starting
The Services</a><br>





























<a href="#prev_abuse">Preventing Abuse</a><br>








<a href="#encryption">Full SSL/TLS Encryption</a><br>
























<a href="#antivirus">Clam Antivirus</a><br>








<a href="#spam">SpamAssassin</a><br>





























<br>





























Sending emails to multiple recipients scattered around the world these
days is such an easy everyday task, that its hard to image life without
it.
Sending an email through the Internet uses many different protocols and
applications that all work seamlessly to ensure your message reaches
its
end destination.<br>





























<br>





























This chapter will provide assistance in the configuration of your own
server for sending
and receiving emails, and will also provide details on some extra
applications to
ensure your system remains secure and relatively virus free. In <a href="13-Apache_Web_Server.html">chapter
13</a>, we will configure a webmail application which provides a means
to send and receive email while away from home. To make proper use of
an
email system
requires the server to be configured with a fully registered Internet
domain name; DNS is used extensively for email. In <a href="20-Shared_Address_Book_LDAP.html">chapter 20</a>
we will configure LDAP to provide our network with a share address book
(with SSL) to be used by internal and/or roaming clients.<br>





























<br>





























Before we begin, here are some of the basic components that help to
make up the email world:<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="width: 285px;">MUA:
Mail User Agent </td>





























      <td style="width: 611px;">The
email application that a user
sends/receives (thunderbird,pine,outlook)<br>





























      </td>





























    </tr>





























    <tr>





























      <td style="width: 285px;">MTA:
Mail Transport Agent<br>





























      </td>





























      <td style="width: 611px;">The
server agent responsible for
sending the emails (sendmail,postfix,qmail)<br>





























      </td>





























    </tr>





























    <tr>





























      <td style="width: 285px;">MDA:
Mail Delivery Agent<br>





























      </td>





























      <td style="width: 611px;">The
server agent that accepts email
from MTA, and places into users mailbox (procmail)<br>





























      </td>





























    </tr>





























    <tr>





























      <td style="width: 285px;">SMTP:
Simple Mail Transport Protocol<br>





























      </td>





























      <td style="width: 611px;">MUAs
and MTAs use this protocol for
sending emails<br>





























      </td>





























    </tr>





























    <tr>





























      <td style="width: 285px;">POP3:
Post Office Protocol (Ver 3)<br>





























      </td>





























      <td style="width: 611px;">MUAs
use this protocol for receiving
their emails from the final server<br>





























      </td>





























    </tr>





























    <tr>





























      <td style="width: 285px;">IMAP:
Internet Message Access Protocol</td>





























      <td style="width: 611px;">MUAs
can use this protocol to send and
receive emails on the servers<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























Procmail is normally installed and running on most systems already so
it won't be covered here.<br>













<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Note !!" src="images/note.gif"></td>





























      <td>The preferred email protocol for this
configuration is IMAPS as all emails are stored on the main server and
then replicated through to your MUA client when it connects. Because
the mail files on the server and client are synchronised, the webmail
application will have all the emails contained on your local
workstation and vice versa, including sent emails.<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>





























<h2><a name="config"></a><a href="#top">Basic
Configuration</a><br>





























</h2>





























<h3>Sendmail<br>





























</h3>





























We are going to configure the MTA first, and the package that is most
commonly used is <a href="http://www.sendmail.org">sendmail</a>.
The
configuration files for sendmail are extremely technical for new users,
and should definately be backed up before making any changes, they are
so complex in fact that one configuration file is actually used to
configure the second file.<br>





























<br>





























The important thing to remember is that we will make the changes only
in the <span style="font-family: monospace;">sendmail.mc</span>
file,
and the changes will be moved into the <span style="font-family: monospace;">sendmail.cf</span>
file for us. This
is the preferred method for configuring sendmail.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">cp
/etc/mail/sendmail.cf
/etc/mail/sendmail.cf.original</span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Caution !!" src="images/caution.gif"></td>





























      <td>Do not edit sendmail's
"cf" file, use the "mc" macro file to
make the changes. This backup is only a precautionary measure in case
everything goes bad.<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">cp
/etc/mail/sendmail.mc
/etc/mail/sendmail.mc.original</span><br>





























[bash]# <span style="font-weight: bold;">vi /etc/mail/sendmail.mc</span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























Inside the sendmail macro file, there are many lines that
start and end with "<span style="font-weight: bold;">dnl</span>".
This
acronym stands for "delete through newline", and is used to tell the
macro process to ignore the current line when building the new
sendmail.cf file. This should be treated just like a standard
configuration comment.<br>





























<br>





























When sendmail dispatches your email, it places the servers hostname
behind your username, which becomes the "from address" in the email
(ie. user@galaxy.example.com). Normally we only want to use the
domainname and not the hostname, this setting allows all outgoing
emails to be "user@example.com", the preferred method.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>define(`confDOMAIN_NAME',
`example.com')dnl<br>





























FEATURE(`relay_entire_domain')dnl<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























Email can be sent via a smarthost if the Internet connection is
not on all the time. This needs configuring at your ISP or by whoever
is
providing your smarthost capability. This is generally not required on
a dedicated
link.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>dnl
define(`SMART_HOST',`smtp.your.provider')dnl<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























Below are some daemon options that specify (basically) who can connect
and send emails. The top
one (default) only allows emails to be sent from by the local server.
The
default options need to be adjusted before the server will accept
emails
from any other networked computer.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="width: 437px;">DAEMON_OPTIONS(`Port=smtp,Addr=127.0.0.1,
Name=MTA')dnl </td>





























      <td style="width: 459px;">Only
local server can send email<br>





























      </td>





























    </tr>





























    <tr>





























      <td style="width: 437px;">DAEMON_OPTIONS(`Port=smtp,
Name=MTA')dnl</td>





























      <td style="width: 459px;">Users
can now connect to send email<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























The aliases and virtusertable ("<span style="font-family: monospace;">/etc/mail/virtusertable</span>")
are lists that allow incoming emails to be redirected to other local
accounts or external email addresses. See "<span style="font-family: monospace;">man
aliases</span>" or README for
details on these files.<br>





























<br>





























Many of the applications on the server are configured to send email to
the root account when problems occur. It is recommended that an entry
be placed into the /etc/aliases file to redirect all of root's email to
the supervisors standard user account. This saves having to check the
root account for emails as they can be automatically sent to another
valid account.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>define(`ALIAS_FILE',
`/etc/aliases')dnl </td>





























    </tr>





























    <tr>





























      <td>FEATURE(`virtusertable',`hash
-o
/etc/mail/virtusertable.db')dnl</td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Note !!" src="images/note.gif"></td>





























      <td>If alias file (<span style="font-family: monospace;">/etc/aliases</span>)
is adjusted, it needs to be updated with the "<span style="font-family: monospace;">newaliases</span>"
command before
settings are implemented.<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























The access database ("<span style="font-family: monospace;">/etc/mail/access</span>")
is a list of IP addresses and domainnames of allowable connections.
Your
IP subnet and other details need to be placed in here before you can
send email, ensuring that you leave the localhost information as
configured.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>FEATURE(`access_db',`hash
-T&lt;TMPF&gt; -o
/etc/mail/access.db')dnl</td>





























    </tr>





























    <tr>





























      <td><span style="font-weight: bold;"># Example of
/etc/mail/access</span><br>





























localhost.localdomain&nbsp;&nbsp;&nbsp;&nbsp; RELAY<br>





























localhost&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
RELAY<br>





























127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
RELAY<br>





























192.168.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
RELAY<br>





























example.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
RELAY<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























Before accepting emails, sendmail can do a DNS lookup on the address of
the person who
is sending the email. It is recommended that this option be set up so
that any
email failing a DNS lookup is rejected; there is a fair chance the
email was not sent from a valid domain name and possibly spoofed.
Comment the following line
to enable DNS lookup.<br>

























<br>

























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>dnl
FEATURE(`accept_unresolvable_domains')dnl </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Caution !!" src="images/caution.gif"></td>





























      <td>You should consult the
README file for further details on
available settings (<span style="font-family: monospace; font-weight: bold;">"/usr/share/sendmail-cf/README"</span>).<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>












<h3>Mail Aliases - Who gets Who's Email</h3>












Sendmail includes a standard <span style="font-weight: bold; font-family: monospace;">"/etc/aliases"</span>
file that can be used to redirect certain emails to a single user on
the system, a group of users, or even to an email address external of
the mail system (i.e. to another organisation). The basic alias file
looks similar to below, it contains an alias on the left side followed
by a colon and then the list of users that will receive the email,
listed on the right hand side.<br>






<br>






It is important to nominate an account to redirect all the system
emails to, i.e. a "root" alias. This ensures that any system orientated
alerts are directed to an individual who can monitor the system's
status and warning messages.<br>






<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">cp /etc/aliases</span><span style="font-weight: bold;"> /etc/aliases.original</span><br>












      <span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">vi /etc/aliases</span><span style="font-weight: bold;"></span>
















      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <tr>












      <td># Our Own Aliases<br>












www:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; root<br>












admin:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; root<br>












sysadmin:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; root<br>












webmaster:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; root<br>






support:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; helpdesk<br>












      <br>












# Person who should get root's mail<br>












root:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; john &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="font-weight: bold; color: rgb(255, 0, 0);">&lt;-- John will receive all system/security email alerts meant for root.<br>












      </span><span style="font-weight: bold;"></span><br>












# People who have left our organisation - Mail redirection...<br>












sarah: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sarah@otherdomain.org<br>












tom: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tom@differentorganisation.org<span style="font-weight: bold; color: rgb(255, 0, 0);"></span></td>












    </tr>












  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>






Aliases can also be configured to for mutliple recipients, this is a
convenient way to create generic group email accounts outside of a
global address book. With this example, a file is created with a list
of mail receipiants listed on one line at a time.<br>






<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">vi /etc/mail/mailing-list</span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <tr>












      <td>alice@wonderland.com<br>






peter@nevernever.org<br>






harry@potterworld.net<br>






      </td>












    </tr>












  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>



























<br>






The "mailing-list" alias is listed in the alias table, and the file
containing the list of users is also added with the use of an "include"
statement; this tests sendmail where the list of users can be found for
the mailing-list. Alternatively, an alias can have several recipients
listed directly aside the alias, separated by commas.<br>






<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">vi /etc/aliases</span><span style="font-weight: bold;"></span>
















      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <tr>












      <td># Our Own Aliases<br>






sysadmins: &nbsp; &nbsp; &nbsp;john,mark,lisa<br>






mailing-list:&nbsp;&nbsp; :include:/etc/mail/mailing-list<br>






      <span style="font-weight: bold; color: rgb(255, 0, 0);"></span></td>












    </tr>












  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>






After the alias table has been adjusted, the <span style="font-weight: bold; font-family: monospace;">"newaliases"</span> command needs to be executed before the table will be used by sendmail again.<br>












<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;"><span style="font-family: monospace;">newaliases</span></span><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <tr>












      <td>/etc/aliases: 97 aliases, longest 31 bytes, 998 bytes total</td>












    </tr>












  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>
























<h2><a name="dovecot"></a><a href="#top">Dovecot IMAP Server</a><br>





























</h2>





























Now that the sendmail server has been setup to allow the sending of
emails, we need to configure a means for the user to retrieve any
emails that are waiting for them on the server. One of the packages
that does this is <a href="http://www.dovecot.org">dovecot</a>,
which
handles POP and IMAP mailboxes in
clear text or with link encryption (POPS and IMAPS); IMAPS is the preferred mail protocol for MUAs.<br>





























<br>





























Dovecot is relatively easy to configure,
but backing up the config file is still important.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">cp
/etc/dovecot.conf /etc/dovecot.conf.original</span><span style="font-weight: bold;"></span><br>





























[bash]# <span style="font-weight: bold;">vi /etc/dovecot.conf</span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























Dovecot needs to be told which protocols it will accept for incoming
client connections, the setting below is the main dovecot configuration file; note its detail for both IMAP and POP3 protocols.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold; color: rgb(255, 0, 0);"></span>protocols = imap pop3<br>























      <br>






















login_dir = /var/run/dovecot/login<br>






















login_chroot = yes<br>






















login_user = dovecot<br>






















      <br>






















protocol imap {<br>






















login_executable = /usr/libexec/dovecot/imap-login<br>






















mail_executable = /usr/libexec/dovecot/imap<br>










login_greeting_capability = yes<br>






















}<br>






















      <br>






















protocol pop3 {<br>






















login_executable = /usr/libexec/dovecot/pop3-login<br>






















mail_executable = /usr/libexec/dovecot/pop3<br>






















pop3_enable_last = no<br>










}<br>






















      <br>






















auth_executable = /usr/libexec/dovecot/dovecot-auth<br>






















auth_process_size = 256<br>






















auth_cache_ttl = 3600<br>






















      <br>






















auth default {<br>






















&nbsp; mechanisms = plain<br>






















&nbsp; user = root<br>






















&nbsp; ssl_require_client_cert = no<br>






















&nbsp; passdb pam {<br>






















&nbsp; }<br>






















&nbsp; userdb passwd {<br>






















&nbsp; }<br>






















}<br>






















 </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Caution !!" src="images/caution.gif"></td>





























      <td>If you plan on setting
up SquirrelMail for your webmail requirements, you will need to have the IMAP
protocol enabled.<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<span style="color: rgb(255, 0, 0); font-weight: bold;"></span><br>





























<h3>User Email Accounts</h3>





























When a standard user account is created on the server, that user is
automatically granted access to login to the system and is also able to
send and receive emails. The user now really only needs to configure
their MUA with the details of the servers address and their account
details, and email should be fully accessible.<br>





























<br>





























Creating a standard user account with a false shell stops that account
from being able to log into the system (a Linux login), but still allows them to use
the system for the purpose of sending and receiving emails. Creating a
user account using the following example, is the easiest method for
creating email only accounts for friends and family where they do not
require login access to the server.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">useradd -c "Alice Jones" -s
/sbin/nologin alice</span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























Email only accounts forbid a user from logging in and accessing their
home directories. These accounts may not be suitable if users expect
access to their "public_html" directories if they are present.<br>





























<br>





























You may also consider placing all of the email only accounts into an
appropriately named group for easy management.<br>





























<br>





























<h2><a name="starting"></a><a href="#top">Starting
the Services</a></h2>





























Starting the newly configured services are relatively straight forward,
however if any changes have been made to the sendmail macro file or
access lists, then the sendmail.cf file will need to be recompiled
before any of the
changes will be accepted. These days many of the initscripts handle
this task automatically, however its good to do it manually just to be
certain.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">make -C
/etc/mail</span> </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























The services should now be set at the appropriate runlevels and then
checked
to ensure they are correct.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">chkconfig
--level 2345 sendmail on</span><br>





























[bash]# <span style="font-weight: bold;">chkconfig
--level 2345 dovecot on</span><br>





























[bash]# <span style="font-weight: bold;">chkconfig
--list sendmail</span><br>





























[bash]# <span style="font-weight: bold;">chkconfig
--list dovecot</span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























The services can now be started. The system logs should also be checked
to ensure there are no errors.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">/etc/init.d/sendmail
restart</span><br>





























[bash]# <span style="font-weight: bold;">/etc/init.d/dovecot restart</span><span style="font-weight: bold;"></span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <tr>














      <td>














[bash]# <span style="font-weight: bold;">grep sendmail /var/log/maillog<br>














      </span>[bash]# <span style="font-weight: bold;">grep dovecot /var/log/maillog</span><br>














      </td>














    </tr>














  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























You've got email !<br>




















<br>





























<h2><a name="prev_abuse"></a><a href="12-Sendmail_Server.html#top">Preventing Abuse</a><br>





























</h2>



























<h3>Open mail relays</h3>






The worst exploitation of an email system is if its able to relay
emails for everyone, this allows spammers and other nasty organisations
to use your unprotected system as a platform for their malicious
activities. Although we have defined who can use the system in the
above configurations (access database), we can take extra precautions
to minimise the effects of any possible damage.<br>






<br>






The following example is a basic open relay test that you can perform
on your sendmail server as an example of how easy it is for a spammer
to send emails through an insecured MTA. Firstly you need to telnet
into your server on port 25 (SMTP) and then cut and paste the following
text into the telnet session; remembering to change the "RCPT To:"
address to your own email.<br>



<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-family: mon;"><span style="font-weight: bold;">telnet localhost 25</span></span><span style="font-weight: bold;"></span><br>




















      </td>




















    </tr>




















    <tr>




















      <td><span style="font-weight: bold; color: rgb(255, 0, 0);">(CUT AND PASTE BELOW TEXT)<br>




















(Change "RCPT To:" email address)<br>




















      </span><br>




















HELO example.com<br>




















MAIL From: TheBoss@example.com<br>




















RCPT To: sysadmin@example.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="font-weight: bold; color: rgb(255, 0, 0);">&lt;-- Change this to your own email to see results.</span><br>




















DATA<br>




















Subject: Think we're insecure...<br>




















I have a feeling our mail server is being abused...<br>




















.<br>




















QUIT</td>




















    </tr>




















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




















<br>






Now if you check your email you will notice an email from "TheBoss" and
you'll see how easy it is to spoof an email. If this worked, it means
that you have probably enabled your <span style="font-weight: bold;">"/etc/mail/access"</span>
database with the correct RELAY permissions for it to occur. However,
we only want to allow the correct clients to be able to relay through
the MTA.<br>






<br>






The following telnet test is an another open relay test that will
automatically test your system from a remote Internet based relay
attempt. Approximately 19 relay tests are conducted with results
displayed as they occur, this is a good test of your systems
configuration; it your server is open to relay, the spammers will find
you soon.<br>




















<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]#&nbsp;<code style="font-weight: bold;">telnet relay-test.mail-abuse.org</code><span style="font-weight: bold;"></span><br>




















      </td>




















    </tr>




















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




















<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Caution !!" src="images/caution.gif"></td>





























      <td>If any of the open relay tests return
serious warnings, you should seriously check your systems configuration
- guaranteed your system will be exploited.<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<span style="color: rgb(255, 0, 0); font-weight: bold;"></span><br>






<h3>Email limits</h3>






The default file size for sendmail is unlimited, so if someone tries to
send a tar archive over 2 GB throught the system, it will most likely
crash the MTA while trying. A maximum file size should be set so
sendmail knows when
to reject a file that is too large.<br>





























<br>





























<table style="text-align: left; font-family: monospace; background-color: rgb(220, 220, 220); width: 100%;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    






















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <tr>






      <td><span style="font-weight: bold;"></span>[bash]#&nbsp;<span style="font-weight: bold;">vi /etc/mail/sendmail.mc</span></td>






    </tr>






    <tr>






      <td>define(`confMAX_MESSAGE_SIZE',`52428800')dnl</td>






    </tr>






  
  
  
  
  
  
  </tbody>
</table>




























<br>






If you are using a PHP based webmail application like SquirrelMail, you
can adjust the max file size for PHP to match the same amount; this
allows PHP applications to match your mail server size limits.<br>





























<br>





























<table style="text-align: left; font-family: monospace; background-color: rgb(220, 220, 220); width: 100%;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    






















    <tr>





























      <td><span style="font-weight: bold; color: rgb(255, 0, 0);">## ONLY NEEDED TO SUPPORT PHP WEBMAIL
##</span><br>





























[bash]# <span style="font-weight: bold;">vi /etc/php.ini</span><br>





























post_max_size = 50M<br>

















upload_max_filesize = 50M<br>

















memory_limit = 64M<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























The following settings limit the rate of connections, the amount of
running 'children', and the maximum number of recipients for each
email. By specifying these types of directives it limits the rate of
any possible exploitation or Denial of Service attacks. These would be
suitable for a small office
or home network, but may need to be increased for larger demands.<br>





























<br>





























<table style="text-align: left; font-family: monospace; background-color: rgb(220, 220, 220); width: 100%;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>define(`confMAX_DAEMON_CHILDREN',`5')dnl<br>





























define(`confCONNECTION_RATE_THROTTLE',`3')dnl<br>





























define(`confMAX_RCPTS_PER_MESSAGE',`50')dnl<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>






This section provides a few basic settings as&nbsp;an introduction to
possible abuse situations and should provide you with
some&nbsp;security considerations for your system. You should always
check your
system logs for any signs of abuse, and do some form of test attack on
your own system (from the outside of course).<br>




















<br>
























<h2><a name="encryption"></a><a href="#top">Full SSL/TLS Encryption</a></h2>
























One of the easiest ways for any system to be exploited is for a
username and password to be intercepted whilst traveling through the
Internet, the basic action of logging into your server from the
external (Internet) side opens your user credentials to such a risk.
Luckly both Sendmail and Dovecot can both be covered by TLS and SSL
encryption systems to ensure your credentials and correspondence stay
safe.<br>





<br>
To configure sendmail with TLS / SSL encryption, edit the main
configuration file and make the following changes. The first setting
disables plain text authentication, the second defines the trusted
authentication mechanisums (to allow relaying), the third defines
the&nbsp;SSL
certificate files and the fourth enables the TLS link encryption and
opens port 465 for secure emails (SMTPS).<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold;"></span>[bash]#&nbsp;<span style="font-weight: bold;">vi /etc/mail/sendmail.mc</span> </td>





























    </tr>





























  
  
  
  
  <tr>
























      <td>define(`confAUTH_OPTIONS', `A p')dnl</td>
























    </tr>
























    <tr>
      <td>TRUST_AUTH_MECH(`EXTERNAL DIGEST-MD5 CRAM-MD5 LOGIN PLAIN')dnl<br>
define(`confAUTH_MECHANISMS', `EXTERNAL GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN PLAIN')dnl</td>
    </tr>
    <tr>
























      <td>define(`confCACERT_PATH',`/etc/pki/tls/certs')dnl<br>
























define(`confCACERT',`/etc/pki/tls/certs/ca-bundle.crt')dnl<br>
























define(`confSERVER_CERT',`/etc/pki/tls/certs/sendmail.pem')dnl<br>
























define(`confSERVER_KEY',`/etc/pki/tls/certs/sendmail.pem')dnl</td>
























    </tr>
























    <tr>
























      <td>DAEMON_OPTIONS(`Port=smtps, Name=TLSMTA, M=s')dnl</td>
























    </tr>
























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>
























<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Note !!" src="images/note.gif"></td>





























      <td>The bottom option causes sendmail to
additionally listen for secure connections on port 465 through enforced
SSL. Basic SMTP is still configured through port 25 for remote MTA
connections and TLS.<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>



























<br>





In our initial configuration, we allowed sendmail to accept SMTP email
from all hosts (the default is only from 127.0.0.1, itself). By
changing this setting back to it's default, then only the local server
can send unsecured emails, this is ideal if you are going to configure
webmail to run from the local Apache web server.<br>





<br>





<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    




  
  
  
  
  <tr>
























      <td><span style="font-weight: bold; color: rgb(255, 0, 0);">Change This:</span><br>
























DAEMON_OPTIONS(`Port=smtp, Name=MTA')dnl<br>
























      </td>
























    </tr>
























    <tr>
























      <td><span style="font-weight: bold; color: rgb(255, 0, 0);">Back To:</span><br>





























  




    




      DAEMON_OPTIONS(`Port=smtp, Addr=127.0.0.1,
Name=MTA')dnl</td>
























    </tr>
























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>
























<br>





Now that sendmail had been configured for encrypted connections and
authentication, you will need to create your SSL certificates before
you can activate your new configuration; this can be done using the
automated scripts located in the <span style="font-family: monospace;">"<span style="font-weight: bold;">/etc/pki/tls/certs</span>"</span> directory.<br>





<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">cd&nbsp;/etc/pki/tls/certs</span><br>
























[bash]# <span style="font-weight: bold;">make sendmail.pem</span> </td>





























    </tr>





























  
  
  
  
  <tr>
























      <td>Country Name (2 letter code) [GB]:<span style="color: rgb(255, 0, 0); font-weight: bold;">AU</span><br>
























State or Province Name (full name) [Berkshire]:<span style="color: rgb(255, 0, 0); font-weight: bold;">QLD</span><br>
























Locality Name (eg, city) [Newbury]:<span style="color: rgb(255, 0, 0); font-weight: bold;">Brisbane</span><br>
























Organization Name (eg, company) [My Company Ltd]:<span style="font-weight: bold; color: rgb(255, 0, 0);">Miles Brennan</span><span style="font-weight: bold; color: rgb(255, 0, 0);"></span><br>
























Organizational Unit Name (eg, section) []:<span style="font-weight: bold; color: rgb(255, 0, 0);"></span><span style="font-weight: bold; color: rgb(255, 0, 0);">Home Linux Server</span><span style="font-weight: bold; color: rgb(255, 0, 0);"></span><br>
























Common Name (eg, your name or your server's hostname) []:<span style="font-weight: bold; color: rgb(255, 0, 0);">galaxy.example.com</span><br>
























Email Address []:<span style="font-weight: bold; color: rgb(255, 0, 0);">sysadmin@example.com</span></td>
























    </tr>
























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>





You should now be able to send secure emails to your MTA (Sendmail) for delivery to remote addresses.<br>





<br>





The next step is to configure Dovecot so you may be able to
successfully retrieve emails from your mail server using SSL
encryption; sending is only half way there, the receive path also needs
to be configured. Open your Dovecot configuration and make the
following adjustments. A point to note is that we are configuring the
Dovecot server to use the exact same SSL certificates that the Sendmail
server is using.<br>





<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-family: mon;"><span style="font-weight: bold;">vi /etc/dovecot.conf</span></span><span style="font-weight: bold;"><br>
























      </span> </td>





























    </tr>





























  
  
  
  
  <tr>
























      <td><span style="font-weight: bold; color: rgb(255, 0, 0);"></span>ssl_disable = no<br>






















ssl_verify_client_cert = no<br>






















ssl_parameters_regenerate = 168<br>






















ssl_cipher_list = ALL:!LOW<br>






















ssl_cert_file = /etc/pki/tls/certs/sendmail.pem &nbsp; &nbsp; <span style="font-weight: bold; color: rgb(255, 0, 0);">&lt;-- NOTE: Can use same certificate as Sendmail</span><br>






















ssl_key_file = /etc/pki/tls/certs/sendmail.pem &nbsp;&nbsp; &nbsp; <span style="font-weight: bold; color: rgb(255, 0, 0);">&lt;-- NOTE: Can use same certificate as Sendmail</span><br>






















disable_plaintext_auth = yes<br>






















      </td>






















    </tr>






















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>






















<br>





We can also block Dovecot from allowing any insecure client connections
by forcing the server to only accept secure IMAPS and POP3S connections.<br>





<br>

























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td colspan="1" rowspan="1" style="width: 437px;"><span style="font-weight: bold; color: rgb(255, 0, 0);">Change This:</span><br>





















protocols = imap pop3</td>





























      







    </tr>





























    <tr>





















      <td><span style="font-weight: bold; color: rgb(255, 0, 0);">To This:</span><br>





















protocols = imaps pop3s</td>





















    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>































<br>





Now that the services have both been configured, the services will need to be restarted.<br>





<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">/etc/init.d/sendmail
restart</span><br>





























[bash]# <span style="font-weight: bold;">/etc/init.d/dovecot restart</span><span style="font-weight: bold;"></span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>




















If you have users on the external side of your firewall (i.e. on the
Internet), you can allow both SMPTS (port 465) and IMAPS (port 993)
connections to pass through your firewall with the following
adjustments to your firewall script. Remember that port 25 (SMTP) is
still required and will use TLS as required.<br>




















<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">vi /root/firewall.sh</span><span style="font-weight: bold;"></span>










      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  <tr>




















      <td># New INBOUND Connection: SMTP and SMTPS (over SSL)<br>













iptables -A INPUT -i $EXT_DEV -m state --state NEW -m tcp -p tcp --syn
--dport 25&nbsp; -j ACCEPT&nbsp;&nbsp;<span style="font-weight: bold; color: rgb(255, 0, 0);">&lt;-- for TLS encryption (and basic SMTP)</span><br>














iptables -A INPUT -i $EXT_DEV -m state --state NEW -m tcp -p tcp --syn
--dport 465 -j ACCEPT&nbsp;&nbsp;<span style="font-weight: bold; color: rgb(255, 0, 0);">&lt;-- for SSL encryption</span><br>














      <br>













# New INBOUND Connection: IMAPS Email Clients (Secure Link - In and Out)<br>














iptables -A INPUT -i $EXT_DEV -m state --state NEW -m tcp -p tcp --syn
--dport 993 -j ACCEPT&nbsp;&nbsp;<span style="color: rgb(255, 0, 0); font-weight: bold;">&lt;-- for SSL encryption</span><br>





















      <span style="font-weight: bold;"></span></td>




















    </tr>




















  
  
  
  
  
  
  
  
  
  
  <tr>









      <td><span style="font-weight: bold;"></span>[bash]#&nbsp;<span style="font-weight: bold;">/root/firewall.sh</span></td>









    </tr>









  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>




















By default the Dovecot server will listen on all interfaces when we
declare a protocol to be configured. However we can add the following
options to the protocol declaration to define a more detailed
configuration.<br>





<br>





The following Dovecot configuration causes both the secure IMAPS and
POP3S protocols on be active on all network interfaces, but also allow
Dovecot to operate the insecure IMAP protocol only from the localhost
server, this again is an ideal configuration if you intend to run
SquirrelMail on your server and it is an IMAP based application.<br>






<br>






























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">






























  <tbody>






























    <tr>






























      <td><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">vi /etc/dovecot.conf</span><span style="font-weight: bold;"></span>










      </td>






























    </tr>






























  
  
  
  
  
  
  
  
  
  
  <tr>



















      <td><span style="font-weight: bold; color: rgb(255, 0, 0);"></span>protocols = imap imaps pop3s<br>














      <br>














protocol imap {<br>














listen = 127.0.0.1<br>














ssl_listen = *<br>














ssl_disable = no<br>














}</td>



















    </tr>



















    







  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Note !!" src="images/note.gif"></td>





























      <td>The above Dovecot settings allow for
the IMAP based SquirrelMail application to work on the local server
without requiring TLS/SSL encryption. A remote user will still
interface the HTTPS web interface through SSL, ensuring secure access
through a web browser.<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>


























<br>





























<h2><a name="antivirus"></a><a href="#top">Clam Antivirus</a><br>





























</h2>





























<span style="font-weight: bold;"></span>There is really no such thing as a virus in the Linux world and what
you would call a virus is really nothing more than an exploit or
maliciously crafted piece of code. Some not so better operating systems however are
quite susceptible to virus attacks and the number one means of virus
infection is currently via the email system. Although your Linux MTA itself is quite
safe from any possible virus threats, we have a duty of care to at
least protect
our internal workstations that may face a somewhat different fate.<br>





























<br>





























<a href="http://www.clamav.net">Clam
AntiVirus</a> is an opensource
antivirus scanning toolkit for UNIX systems. Effectively it runs as its
own independent service with its own
suite of applications, these need to be interfaced by other
applications in
order to use the scanning facilities. Sendmail interfaces into clamav
with whats
called a milter (Mail Filter), and the results are returned to sendmail
for further processing.<br>





























<h3>Clamav-Milter</h3>



























Firstly we need to install the clamav suite of applications, this
command will install the clamav server and the milter required to work
with Sendmail.<br>

<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">yum install clamav*</span></td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>



























The clam daemon configuration file should be backed up before any
adjustments are made.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">cp /etc/clamd.d/milter.conf /etc/clamd.d/milter.conf.original</span><br>





























[bash]# <span style="font-weight: bold;">vi&nbsp;/etc/clamd.d/milter.conf</span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























The following is an example of a typical clamd configuration file. The
<span style="font-family: monospace; font-weight: bold;">"/etc/clam.d/clamd.conf"</span> file is well documented with configuration options and
further detailed information can be obtained from reading the
supporting man page. Type <span style="font-family: monospace; font-weight: bold;">"man
clamd.conf"</span> at the command
prompt.<br>





























<br>





























The "<span style="font-family: monospace;">Example</span>"
option must
be commented out before the daemon will start.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>#Example &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="font-weight: bold; color: rgb(255, 0, 0);">&lt;-- This must be commented out before the daemon will function</span><br>
























LogFile /var/log/clamd.milter<br>
























LogFileMaxSize 5M<br>
























LogTime<br>
























DatabaseDirectory /var/lib/clamav<br>
























      LocalSocket /var/run/clamd.milter/clamd.sock<br>
























FixStaleSocket<br>
























#TCPAddr 127.0.0.1<br>
























#TCPSocket 3310<br>
























User clamilt<br>
























ScanMail<br>
























ScanHTML<br>
























DetectBrokenExecutables<br>
























ArchiveBlockEncrypted</td>
























    </tr>
























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>
























<br>



On one side we have a running MTA (Sendmail) and the other side we have a fully
functional antivirus system, clamav-milter is the glue that binds it
all together. As an email is passed onto the MTA, the milter redirects
it to the antivirus server and awaits the results.<br>





























<br>



The
following parameters detail how the milter will act and respond between
the other two systems; should it just drop all infected email, should
it
notify the recipient or the sender, should it inform the administrator;
there are numerous available options. You should consult the man page
to
configure the settings that will best suit your needs. Type "<span style="font-family: monospace;">man
clamav-milter</span>" at the
command prompt for more details.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">cp
/etc/sysconfig/clamav-milter</span><span style="font-weight: bold;">
/etc/sysconfig/clamav-milter.original</span><br>
























[bash]# <span style="font-weight: bold;">vi
/etc/sysconfig/clamav-milter</span><span style="font-weight: bold;"></span>




      </td>





























    </tr>





























    <tr>





























      <td>CLAMAV_FLAGS="--local \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --bounce \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --advisory \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --force-scan \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --dont-wait \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --dont-log-clean \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --max-children=2 \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --server=localhost \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --postmaster=sysadmin@example.com \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --config-file=/etc/clamd.d/milter.conf \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --pidfile=/var/run/clamav-milter/milter.pid \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
--signature-file=/etc/mail/clamav-email-signature \<br>























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; local:/var/run/clamav-milter/clamav.sock "<br>























CLAMAV_USER='clamilt'<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























In the above sample configuration we are placing a footer
(signature-file) on all the emails that successfully pass thru the
system, as an assurance to the end recipients that the email is virus
free. The following is an example signature file, it isn't required but is an option should your email policy require it.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">vi
/etc/mail/clamav-email-signature</span></td>





























    </tr>





























    <tr>





























      <td>_________________________________<br>





























This email has been ClamScanned !<br>





























&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
www.clamav.net</td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























The service is now ready to run after we set the correct runlevels. The
clamav-milter logs directly to <span style="font-family: monospace; font-weight: bold;">"/var/log/maillog"</span>
when it processes an email, which can be checked after all the
configurations are complete.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">chkconfig
--level 2345 clamav-milter on</span><br>





























[bash]# <span style="font-weight: bold;">chkconfig
--list clamav-milter</span><br>





























      </td>





























    </tr>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">/etc/init.d/clamav-milter restart</span><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























Now that the milter is running, we need to tell sendmail to use it.
Place the following line into the sendmail.mc file, then restart the Sendmail service.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">vi
/etc/mail/sendmail.mc</span></td>





























    </tr>





























    <tr>





























      <td>INPUT_MAIL_FILTER(`clamav-milter',
`S=local:/var/run/clamav-milter/clamav.sock, F=T,T=S:4m;R:4m;E:10m')</td>





























    </tr>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">make -C /etc/mail</span><br>





























[bash]# <span style="font-weight: bold;">/etc/init.d/sendmail restart</span> </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























Thats it !! You are all configured now for antivirus scanning.<br>





























<h3>Testing the Clamav Scanner</h3>





























The easiest way to check if the scanner is functioning, is to check the
mail logs. The details of each email that gets sent by the milter to
clamd is placed in the log, the example below shows how the milter
added the extra header details to the incoming email.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">grep Milter
/var/log/maillog</span></td>





























    </tr>





























    <tr>





























      <td>sendmail: Milter add: header: X-Virus-Scanned: ClamAV version 0.88.2, clamav-milter version 0.88.2 on galaxy.example.com<br>






















sendmail: Milter add: header: X-Virus-Status: Clean<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>





























The email can be checked at the MUA to confirm the presence of the
extra milter headers on all of the incoming emails. This is
confirmation that the system is configured and functioning as expected.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>
      X-Virus-Scanned: ClamAV version 0.88.2, clamav-milter version 0.88.2 on galaxy.example.com<br style="font-family: monospace;">






















      <span style="font-family: monospace;">X-Virus-Status: Clean</span><br>






















      <span style="font-family: monospace;"></span></td>






















    </tr>






















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>






















<br>

The <a href="http://www.eicar.org/">European Institute for Computer Antivirus Research</a>
(EICAR) have created an antivirus test signature that can be used to
test many antivirus programs. Your new Sendmail configuration can be
tested by sending the EICAR test signature through as an email and
check to see if Clamav identified and labelled the email as an infected
message.<br>

<br>

Issue the following command at the command line interface, ensuring
that you change the email address to your own (or one you can access).
When the email arrives at the email address you inserted, you can check
the headers within the email and see if Clamav has inserted the
following flags.<br>






















<br style="font-family: monospace;">





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]#  <span style="font-weight: bold;">echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' | mail sysadmin@example.com</span><span style="font-weight: bold;"></span></td>





























    </tr>





























    <tr>





























      <td>
      
      
      
      
      
      
      To: sysadmin@example.com<br>














X-Virus-Scanned: ClamAV version 0.88.2, clamav-milter version 0.88.2 on galaxy.example.com<br>














X-Virus-Status: Infected with Eicar-Test-Signature<br>














Subject: [Virus] Eicar-Test-Signature<br>

















      </td>

















    </tr>

















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>

















<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Note !!" src="images/note.gif"></td>





























      <td>More information about the EICAR test antivirus signature can be seen at this site: <a href="http://www.eicar.org/anti_virus_test_file.htm">




















http://www.eicar.org/anti_virus_test_file.htm</a>



























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>


























<br>





























<h3>Freshclam updates</h3>
























The Clam Antivirus system is only as effective as its latest copy of
the virus definitions, these can be updated using the freshclam
application. Make the following adjustments to your freshclam settings,
ensuring you ADD a "#" (comment) to the <span style="font-weight: bold; font-family: monospace;">"FRESHCLAM_DELAY"</span> directive, this enables the update service.<br>



<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">vi /etc/sysconfig/freshclam</span><br>
























      </td>





























    </tr>





























  
  
  
  
  <tr>
























      <td>FRESHCLAM_MOD=180 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="font-weight: bold; color: rgb(255, 0, 0);">&lt;-- Update interval in minutes</span><br>






















#FRESHCLAM_DELAY=disabled-warn&nbsp;&nbsp; <span style="font-weight: bold; color: rgb(255, 0, 0);">&lt;-- Add "#" to activate (enable) clamav updates</span></td>
























    </tr>
























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>
























The main antivirus functions are now running and freshclam can be
configured to keep the system up to date with the latest virus
patterns.
As normal the configuration file should be backed up.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">cp
/etc/freshclam.conf /etc/freshclam.conf.original</span><br>





























[bash]# <span style="font-weight: bold;">vi /etc/freshclam.conf</span> </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>
























This is an example of the freshclam configuration file. This file too
is well documented and the supporting man page should be consulted for
any further queries. Type <span class="" style="font-weight: bold; font-family: monospace;">"man
freshclam.conf"</span> at the
command prompt.<br>





























<br>





























If your system is behind a firewall or you prefer to use a proxy
server, then ensure that you complete and enable the appropriate HTTPProxy
options for your system.<br>





























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>#Example<br>
























DatabaseOwner clamav<br>
























DatabaseDirectory /var/lib/clamav<br>
























Checks 24<br>
























MaxAttempts 5<br>
























UpdateLogFile /var/log/freshclam.log<br>
























DNSDatabaseInfo current.cvd.clamav.net<br>
























DatabaseMirror db.<span style="font-weight: bold; color: rgb(255, 0, 0); text-decoration: underline;">??</span>.clamav.net&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="font-weight: bold; color: rgb(255, 0, 0);">###&nbsp; &lt;-- See Note.</span><br>
























DatabaseMirror database.clamav.net<br>
























#HTTPProxyServer galaxy.example.com<br>
























#HTTPProxyPort 3128<br>
























#HTTPProxyUsername username<br>
























#HTTPProxyPassword password<br>
























      </td>
























    </tr>
























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>
























<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Note !!" src="images/note.gif"></td>





























      <td>Replace <span style="font-family: monospace; font-weight: bold; color: rgb(255, 0, 0);">"??"</span>
(above) with
the two letter country code for your region, or remove line from configuration file if you are unsure.<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>



Freshclam will automatically update itself at intervals define with the
earlier "FRESHCLAM_MOD" declaration. However, if you require to update
your antivirus manually to test your configuration, you can execute the
command at the xterm prompt.<br>



<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">freshclam</span></td>





























    </tr>





























    <tr>





























      <td><span style="font-weight: bold;"></span> ClamAV update process started at Sun May 21 12:01:57 2006<br>
























main.cvd is up to date (version: 38, sigs: 51206, f-level: 7, builder: tkojm)<br>
























Downloading daily.cvd [*]<br>
























daily.cvd updated (version: 1472, sigs: 4793, f-level: 8, builder: arnaud)<br>
























Database updated (55999 signatures) from db.au.clamav.net (IP: 61.8.0.16)</td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























<br>























Freshclam keeps a log of all update details.<br>























<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    





    <tr>





























      <td>[bash]# <span style="font-weight: bold;">tail&nbsp;/var/log/freshclam.log</span> </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>





























<h2><a name="spam"></a><a href="#top">SpamAssassin</a><br>





























</h2>





























<span style="font-weight: bold;"></span>One of the biggest wastes of
bandwidth throughout the Internet today is from unwanted/unsolicitated
bulk email, in other words spam; we hate it. Unfortunately for us it
isn't going to go away for a while, fortunately we can at least filter
some of it out of our Inbox by using <a href="http://spamassassin.apache.org/">SpamAssassin</a> which comes standard
now with many Linux distributions. SpamAssassin will at the very least
allow you to take some control back over your email account.<br>




<br>




To install SpamAssassin and the required milter for Sendmail, type the following command at the prompt.<br>





<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]#&nbsp;<span style="font-weight: bold;">yum install spamass-milter spamassassin</span><span style="font-weight: bold;"></span><br>






















      <span style="font-weight: bold;"></span></td>





























    </tr>





























    








  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>

























<br>



SpamAssassin has many plugins written and available for use, they can be enabled in the <span style="font-weight: bold; font-family: monospace;">"/etc/mail/spamassassin/v310.pre"</span> plugin file. The plugins file is the first configuration to be loaded by SpamAssassin.<br>



<br>
































<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">cp&nbsp;/etc/mail/spamassassin/v310.pre /etc/mail/spamassassin/v310.pre.original</span><br>






















[bash]# <span style="font-weight: bold;">vi /etc/mail/spamassassin/v310.pre</span><span style="font-weight: bold;"></span></td>





























    </tr>





























    <tr>





























      <td>loadplugin Mail::SpamAssassin::Plugin::DCC<br>






















loadplugin Mail::SpamAssassin::Plugin::Pyzor<br>






















loadplugin Mail::SpamAssassin::Plugin::Razor2<br>






















loadplugin Mail::SpamAssassin::Plugin::SpamCop<br>






















loadplugin Mail::SpamAssassin::Plugin::AWL<br>






















loadplugin Mail::SpamAssassin::Plugin::AutoLearnThreshold<br>






















loadplugin Mail::SpamAssassin::Plugin::WhiteListSubject<br>






















loadplugin Mail::SpamAssassin::Plugin::MIMEHeader<br>






















loadplugin Mail::SpamAssassin::Plugin::ReplaceTags<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>



























<br>



The <span style="font-weight: bold; font-family: monospace;">"/etc/mail/spamassassin/local.cf"</span> file is the main global configuration file for the whole server and can be configured like so.<br>






















<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]#&nbsp;<span style="font-weight: bold;">cp&nbsp;</span><span style="font-weight: bold;">/etc/mail/spamassassin/local.cf </span><span style="font-weight: bold;">/etc/mail/spamassassin/local.cf.original</span><br>






















[bash]# <span style="font-weight: bold;">vi /etc/mail/spamassassin/local.cf</span><span style="font-weight: bold;"></span></td>





























    </tr>





























    <tr>





























      <td>required_score&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5.0<br>






















rewrite_header subject&nbsp; [SPAM]<br>






















report_safe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>






















use_bayes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>














use_bayes_rules &nbsp; &nbsp; &nbsp; &nbsp; 1<br>






















bayes_auto_learn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>






















skip_rbl_checks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br>






















use_razor2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>






















use_dcc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>






















use_pyzor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>














trusted_networks &nbsp; &nbsp; &nbsp; &nbsp;192.168.1/24 127/8<br>














internal_networks&nbsp; &nbsp; &nbsp; &nbsp;192.168.1/24 127/8<br>





















      </td>





















    </tr>





















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





















<br>





























<table style="width: 100%; text-align: left;" border="1" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="vertical-align: middle; text-align: center; width: 52px;"><img style="width: 24px; height: 24px;" alt="Note !!" src="images/note.gif"></td>





























      <td>If you need assistance in
determining which configuration options are the best for your system,
you can use the online "SpamAssassin Configuration Generator" located
at:
"<a href="http://www.yrex.com/spam/spamconfig.php">http://www.yrex.com/spam/spamconfig.php</a>". your customised online configuration can then be downloaded into your /etc/mail/spamassassin/local.cf file.

























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>




























<br>



To define daemon runtime options, edit the system configuration file for SpamAssassin.<br>






















<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">cp&nbsp;</span><span style="font-weight: bold;">/etc/sysconfig/spamassassin </span><span style="font-weight: bold;">/etc/sysconfig/spamassassin.original</span><br>




















      <span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">vi /etc/sysconfig/spamassassin</span></td>





























    </tr>





























    <tr>





























      <td>SPAMDOPTIONS="-d -c -l -m5 -H"<br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>


























<br>



Users can also fine tune their own options for SpamAssassin by editing
their own user configuration files located in their home drives.<br>



<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[/home/miles]$ <span style="font-weight: bold;">vi ~/.spamassassin/user_prefs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: rgb(255, 0, 0);">&lt;-- executed as basic user</span><br>






















      <span style="font-weight: bold;"></span></td>





























    </tr>





























    






  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>


























<br>




















The SpamAssassin mail filter (milter) can then be configured with runtime options.<br>




















<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">cp&nbsp;</span><span style="font-weight: bold;">/etc/sysconfig/spamass-milter </span><span style="font-weight: bold;">/etc/sysconfig/spamass-milter.original</span><br>




















[bash]# <span style="font-weight: bold;">vi /etc/sysconfig/spamass-milter</span><br>




















      <span style="font-weight: bold;"></span>

      <span style="font-weight: bold;"></span></td>





























    </tr>





























    <tr>





























      <td>SOCKET=/var/run/spamass-milter/spamass-milter.sock<br>




















EXTRA_FLAGS="-r 15"<br>




















      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>

























<br>



The daemons need to be configured to start at the appropriate runlevels
using the following commands, this should also be checked to ensure the
daemons will initialise at expected if needed at next reboot.<br>




















<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">chkconfig
--level 2345 spamassassin on</span><br>






















      <span style="font-weight: bold;"></span><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">chkconfig
--level 2345 spamass-milter on<br>






















      </span>[bash]# <span style="font-weight: bold;">chkconfig
--list spamassassin</span><br>






















      <span style="font-weight: bold;"></span><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">chkconfig
--list spamass-milter</span><br>






















      <span style="font-weight: bold;"></span>






    






    






  
  
  
  
  
  
  



      </td>






















    </tr>






















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>






















<br>






















Once the services has been configured, the daemons can both be restarted.<br>



<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]# <span style="font-weight: bold;">/etc/init.d/spamassassin restart<br>






















      </span>[bash]# <span style="font-weight: bold;">/etc/init.d/spamass-milter restart</span><br>






















      <span style="font-weight: bold;"></span><span style="font-weight: bold;"></span></td>





























    </tr>





























    






  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>


























<br>





















The SpamAssassin configurations have now been completed, however the
mail server has not yet been configured to use the spam filtering
daemon yet. Before we do the final configuration, it is important to
firstly test that SpamAssassin is functioning as expected and the email
that passes through the daemon is handled correctly. If we don't do
these tests then some of your email may just disappear because of a
poorly configured service.<br>



<br>



The first test passes a test email to the spam daemon and&nbsp;returns
the results to the screen. This test email is considered by
SpamAssassin to be clean and should return a clean result.<br>






















<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">spamassassin -t &lt; /usr/share/doc/spamassassin-3*/sample-nonspam.txt | grep X-Spam<br>






















      </span><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span></td>





























    </tr>





























    






  
  
  
  
  
  
  <tr>






















      <td>X-Spam-Checker-Version: SpamAssassin 3.1.1 (2006-03-10) on galaxy.example.com<br>






















X-Spam-Level:<br>






















X-Spam-Status: No, score=0.0 required=5.0 tests=none autolearn=unavailable</td>






















    </tr>






















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>


























<br>






















The second test passes an email that is considered by SpamAssassin to
contain spam signatures, as such the test should return a positive
result to the test. You should note the <span style="font-weight: bold; font-family: monospace;">"X-Spam-Flag: YES"</span>
flag that SpamAssassin inserts into the email's headers, this will
allow users an easily way to identify and automatically sort spam
affected emails into junk email folders as they arrive in their Inboxes.<br>



<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">spamassassin -t &lt; /usr/share/doc/spamassassin-3*/sample-spam.txt | grep X-Spam</span><span style="font-weight: bold;"></span></td>





























    </tr>





























    






  
  
  
  
  
  
  <tr>






















      <td>X-Spam-Flag: YES<br>






















X-Spam-Checker-Version: SpamAssassin 3.1.1 (2006-03-10) on galaxy.example.com<br>






















X-Spam-Level: **************************************************<br>






















X-Spam-Status: Yes, score=1000.0 required=5.0 tests=GTUBE,NO_RECEIVED,</td>






















    </tr>






















  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>


























<br>






















<span style="color: rgb(255, 0, 0); font-weight: bold;"></span>Once you
are happy that the outcomes of both your spam and non-spam tests are
successful, Sendmail can be configured to pass emails to the
SpamAssassin daemon by use of the mail filter (milter).<br>






















<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td>[bash]#&nbsp;<span style="font-weight: bold;">vi /etc/mail/sendmail.mc</span><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span><br>






















      <span style="font-weight: bold;"></span></td>





























    </tr>





























    <tr>





























      <td>INPUT_MAIL_FILTER(`spamassassin', `S=unix:/var/run/spamass-milter/spamass-milter.sock, F=, T=C:15m;S:4m;R:4m;E:10m')dnl<br>






















define(`confMILTER_MACROS_CONNECT',`t, b, j, _, {daemon_name}, {if_name}, {if_addr}')dnl<br>






















define(`confMILTER_MACROS_HELO',`s, {tls_version}, {cipher}, {cipher_bits}, {cert_subject}, {cert_issuer}')dnl</td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>


























<br>






















Now that the SpamAssassin milter settings have been inserted into the
Sendmail configuration, the Sendmail server can be restarted; this will
complete your installation.<br>






















<br>





























<table style="width: 100%; background-color: rgb(220, 220, 220); text-align: left; font-family: monospace;" border="1" cellpadding="5" cellspacing="2">





























  <tbody>





























    <tr>





























      <td><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span><span style="font-weight: bold;"></span>[bash]# <span style="font-weight: bold;">make -C /etc/mail<br>






















      </span>[bash]# <span style="font-weight: bold;">/etc/init.d/sendmail restart</span><span style="font-weight: bold;"></span></td>





























    </tr>





























    






  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>


























<br>



For further information on SpamAssassin configuration, you can view the following man pages: <span style="font-weight: bold; font-family: monospace;">"Mail::SpamAssassin::Conf"</span> and <span style="font-weight: bold; font-family: monospace;">"Mail::SpamAssassin"</span>.<br>






















<br>





























<br>





























<hr>
<table style="width: 100%;" border="0" cellpadding="2" cellspacing="2">





























  <tbody>





























    <tr>





























      <td style="width: 30%; text-align: left;"><a href="11-Squid_Web_Proxy.html">Previous</a><br>





























      </td>





























      <td style="width: 40%; text-align: center;"><a href="index.html">Home</a>
      </td>





























      <td style="width: 30%; text-align: right;"><a href="13-Apache_Web_Server.html">Next</a><br>





























      </td>





























    </tr>





























  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  </tbody>
</table>





























</body>
</html>
